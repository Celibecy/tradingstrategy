在考虑股价“随机游走”特性及概率动态更新（即到达某一目标价后，才能更准确评估下一目标价概率）的现实场景中，更贴切的理论计算方法是**动态规划（Dynamic Programming）结合马尔可夫决策过程（Markov Decision Process, MDP）**，核心是通过“多阶段状态转移”建模，用逆向归纳法计算每个阶段的最优决策，实现动态评估。


### 一、核心建模思路
将股价上涨过程拆解为**“状态转移链”**，每个目标价是一个“状态”，到达某一状态后，基于新信息更新后续状态的概率，再决策卖出策略。具体包括3个核心要素：


#### 1. 状态定义
设当前价格10元为初始状态\( S_0 \)，目标价12元为\( S_1 \)，14元为\( S_2 \)，…，22元为\( S_6 \)（共7个状态）。  
- 状态特征：每个状态\( S_i \)的价格为\( P_i \)（如\( P_0=10 \)，\( P_1=12 \)，…，\( P_6=22 \)）；  
- 状态转移：假设股价只能“依次上涨”（即需先到\( S_1 \)才能到\( S_2 \)，不能跳过），符合实际交易中“逐步达标”的直觉；  
- 终止条件：若未达到下一状态，则过程在当前状态终止（如在\( S_1 \)未涨到\( S_2 \)，则后续不再继续）。


#### 2. 动态概率（条件概率更新）
与静态评估不同，**每个状态的转移概率是“条件概率”**，即到达\( S_i \)后，评估下一状态\( S_{i+1} \)的概率会基于新信息更新（而非初始评估）。  
- 初始状态\( S_0 \)：仅评估\( S_1 \)的概率\( q_1 \)（如你初始估计的95%）；  
- 到达\( S_1 \)后：评估\( S_2 \)的概率为\( q_2|S_1 \)（不再用初始85%，而是基于\( S_1 \)的新信息更新，比如可能更高）；  
- 以此类推：到达\( S_i \)后，\( S_{i+1} \)的概率为\( q_{i+1}|S_i \)（\( q_{i+1}|S_i \)表示“在已到达\( S_i \)的条件下，到达\( S_{i+1} \)的概率”）。  


#### 3. 多阶段决策与期望收益计算
用**动态规划的逆向归纳法**（从最后一个状态倒推），计算每个状态下不同卖出策略的“期望总收益”，核心是贝尔曼方程（Bellman Equation）。


### 二、具体公式与计算步骤
#### 符号定义
- \( N \)：总股数（初始\( N_0=20000 \)）；  
- \( P_i \)：状态\( S_i \)的价格（\( P_0=10 \)，\( P_1=12 \)，…，\( P_6=22 \)）；  
- \( x_i \)：在\( S_i \)时卖出的股数（策略一的卖出量，如\( x_1=1000 \)，\( x_2=1000 \)等；策略二为\( x_i=0 \)直到最后）；  
- \( r_i \)：在\( S_i \)时的剩余股数（\( r_i = r_{i-1} - x_{i-1} \)，初始\( r_0=N_0 \)）；  
- \( q_{i+1}|S_i \)：到达\( S_i \)后，能涨到\( S_{i+1} \)的条件概率；  
- \( V_i(r_i) \)：在\( S_i \)状态下，剩余\( r_i \)股时的“最大期望总收益”（核心变量）。


#### 核心公式（贝尔曼方程）
在状态\( S_i \)下，卖出\( x_i \)股后，剩余\( r_i - x_i \)股，期望总收益由两部分组成：  
1. 当前卖出的现金收益：\( x_i \times P_i \)；  
2. 后续状态的期望收益：若涨到\( S_{i+1} \)，则获得\( S_{i+1} \)状态的期望收益；若未涨到，则剩余股票按\( S_i \)价格计算（假设终止）。  

因此，贝尔曼方程为：  
\[
V_i(r_i) = \max_{x_i} \left[ x_i \times P_i + q_{i+1}|S_i \times V_{i+1}(r_i - x_i) + (1 - q_{i+1}|S_i) \times (r_i - x_i) \times P_i \right]
\]  
- 约束：\( 0 \leq x_i \leq r_i \)（卖出股数不能超过剩余股数）；  
- 边界条件：最后一个状态\( S_6 \)无后续状态，故\( V_6(r_6) = r_6 \times P_6 \)（全部卖出）。  


#### 计算步骤（逆向归纳）
1. **从最后一个状态\( S_6 \)（22元）倒推**：  
   \( V_6(r_6) = r_6 \times 22 \)（剩余股数全卖，无后续）。  

2. **计算\( S_5 \)（20元）的期望收益**：  
   假设在\( S_5 \)时剩余\( r_5 \)股，卖出\( x_5 \)股，转移到\( S_6 \)的概率为\( q_6|S_5 \)，则：  
   \[
   V_5(r_5) = \max_{x_5} \left[ 20x_5 + q_6|S_5 \times V_6(r_5 - x_5) + (1 - q_6|S_5) \times 20(r_5 - x_5) \right]
   \]  
   代入\( V_6 \)得：  
   \[
   V_5(r_5) = \max_{x_5} \left[ 20x_5 + q_6|S_5 \times 22(r_5 - x_5) + (1 - q_6|S_5) \times 20(r_5 - x_5) \right]
   \]  
   化简后可直接计算不同\( x_5 \)下的\( V_5 \)，取最大值。  

3. **依次倒推至\( S_4, S_3, ..., S_0 \)**：  
   每一步用前一状态的\( V_{i+1} \)计算当前\( V_i \)，直到初始状态\( S_0 \)，得到\( V_0(N_0) \)（初始20000股的最大期望收益）。  


### 三、策略对比：动态评估“优劣势转折点”
通过上述公式，可分别计算策略一（分段卖出）和策略二（持有不动）在每个状态的期望收益\( V_i \)，对比后得到：  
- 若策略一的\( V_i \) > 策略二的\( V_i \)，则在\( S_i \)状态下策略一更优；  
- 反之则策略二更优。  


### 四、关键扩展：结合“其他投资标的收益率”
若存在其他期望收益率≥15%的标的，需将“卖出资金的再投资收益”纳入计算。此时，当前卖出的现金\( x_i \times P_i \)在后续阶段可产生收益（按15%复利），公式需调整为：  
\[
V_i(r_i) = \max_{x_i} \left[ x_i \times P_i \times (1 + 0.15)^{t} + q_{i+1}|S_i \times V_{i+1}(r_i - x_i) + (1 - q_{i+1}|S_i) \times (r_i - x_i) \times P_i \right]
\]  
其中\( t \)为现金可投资的时间（如从\( S_i \)到\( S_{i+1} \)的预期时间）。这会让“尽早卖出、用现金投资”的策略更可能占优（尤其当后续状态概率较低时）。


### 总结
这种方法通过**动态规划+马尔可夫决策**，将股价上涨拆解为“状态转移链”，用逆向归纳法结合实时更新的条件概率，计算每个阶段的期望收益，完美贴合“到达某一价格后才评估下一目标”的现实场景。你只需：  
1. 设定各状态的条件概率\( q_{i+1}|S_i \)（随状态更新）；  
2. 代入策略一/二的卖出量\( x_i \)；  
3. 按逆向公式计算\( V_i \)并对比，即可判断在哪个目标价前某策略更优。
